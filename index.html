<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SIM Sale Report + ‡§ó‡§£‡•á‡§∂ ‡§ú‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Ø‡•ã‡§ó</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #d9534f;
    }

    input[type="file"], input[type="number"] {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 80%;
      border-radius: 5px;
      border: 1px solid #ccc;
      text-align: center;
    }

    button {
      display: block;
      margin: 10px auto;
      padding: 10px 30px;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #3498db;
      color: white;
    }

    .info-box {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    #result {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      white-space: pre-line;
    }

    #password-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #password-box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="password-popup">
    <div id="password-box">
      <h3 style="color:#d9534f;">üîí Enter Password</h3>
      <input type="password" id="passInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
             style="padding:10px;width:100%;margin:10px 0;font-size:16px;border:1px solid #ccc;border-radius:5px;text-align:center;" />
      <button id="submitPass"
              style="padding:10px 20px;background:#d9534f;color:white;border:none;border-radius:5px;cursor:pointer;">Submit</button>
      <p id="errorMsg" style="color:red;margin-top:10px;display:none;">‚ùå ‡§ï‡•å‡§® ‡§Ö‡§π‡•á ‡§∞‡•á !!</p>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <div class="info-box" id="live-info">Loading time and weather...</div>

    <h2>SIM Sale Report üìä</h2>
    <input type="file" id="upload" accept=".xlsx, .xls" />
    <div id="tableContainer"></div>

    <hr>

    <h2>‡•ê ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É</h2>
    <p style="text-align:center">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§è‡§ï‡§≤-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Ø‡•ã‡§ó ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</p>
    <input type="number" id="mobileNumber" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)" oninput="limitInput(this)">
    <button onclick="calculateSingleDigitSum()">‡§è‡§ï‡§≤-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Ø‡•ã‡§ó ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
    <input type="file" id="excelFile" accept=".xlsx, .xls">
    <button onclick="processExcelSingleDigit()">Excel ‡§∏‡•á ‡§è‡§ï‡§≤-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Ø‡•ã‡§ó ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
    <div id="result"></div>
  </div>

  <script>
    // Password Protection
    document.getElementById("submitPass").addEventListener("click", function () {
      const input = document.getElementById("passInput").value;
      if (input === "007272") {
        document.getElementById("password-popup").style.display = "none";
        document.getElementById("main-content").style.display = "block";
      } else {
        document.getElementById("errorMsg").style.display = "block";
      }
    });

    // SIM Sale Upload and Table Display
    document.getElementById('upload').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rawData = XLSX.utils.sheet_to_json(sheet);

        const grouped = {};
        const cafTypesSet = new Set();

        rawData.forEach(row => {
          const date = row['Date'] ? new Date(row['Date']).toLocaleDateString() : 'Unknown';
          const retailer = row['Retailer Name'] || 'Unknown';
          const type = (row['Type of CAF'] || '').toUpperCase();
          cafTypesSet.add(type);

          if (!grouped[date]) grouped[date] = {};
          if (!grouped[date][retailer]) grouped[date][retailer] = {};
          if (!grouped[date][retailer][type]) grouped[date][retailer][type] = 0;
          grouped[date][retailer][type]++;
        });

        const cafTypes = Array.from(cafTypesSet);
        const container = document.getElementById('tableContainer');
        container.innerHTML = '';

        Object.keys(grouped).forEach(date => {
          let html = `<h3 style='background-color:#ffeaa7;padding:10px;'>${date}</h3>`;
          html += '<table><thead><tr><th>Retailer Name</th>';
          cafTypes.forEach(type => {
            html += `<th>${type}</th>`;
          });
          html += '<th>Total</th></tr></thead><tbody>';

          const totals = new Array(cafTypes.length).fill(0);
          let grandTotal = 0;

          Object.keys(grouped[date]).forEach(retailer => {
            html += `<tr><td>${retailer}</td>`;
            let rowTotal = 0;
            cafTypes.forEach((type, i) => {
              const count = grouped[date][retailer][type] || 0;
              rowTotal += count;
              totals[i] += count;
              html += `<td>${count}</td>`;
            });
            grandTotal += rowTotal;
            html += `<td>${rowTotal}</td></tr>`;
          });

          html += '<tr><th>Total</th>';
          totals.forEach(t => html += `<th>${t}</th>`);
          html += `<th>${grandTotal}</th></tr></tbody></table>`;
          container.innerHTML += html;
        });
      };
      reader.readAsArrayBuffer(file);
    });

    // Mobile Number Sum
    function limitInput(element) {
      element.value = element.value.replace(/\D/g, '').slice(0, 10);
    }

    function getSingleDigitSum(numberString) {
      let sum = 0;
      for (let i = 0; i < numberString.length; i++) {
        sum += parseInt(numberString[i]);
      }
      while (sum >= 10) {
        let tempSum = 0;
        let sumString = sum.toString();
        for (let i = 0; i < sumString.length; i++) {
          tempSum += parseInt(sumString[i]);
        }
        sum = tempSum;
      }
      return sum;
    }

    function calculateSingleDigitSum() {
      const numberInput = document.getElementById('mobileNumber').value;
      if (numberInput.length !== 10) {
        document.getElementById('result').innerText = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø 10-‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§";
        return;
      }
      const singleDigitSum = getSingleDigitSum(numberInput);
      document.getElementById('result').innerText = `‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§è‡§ï‡§≤-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Ø‡•ã‡§ó ‡§π‡•à: ${singleDigitSum}`;
    }

    function processExcelSingleDigit() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) {
        document.getElementById('result').innerText = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï Excel ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        let html = "<table style='margin: 0 auto;'><tr><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</th><th>‡§è‡§ï‡§≤-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Ø‡•ã‡§ó</th></tr>";
        let foundNumbers = false;

        jsonData.forEach(row => {
          row.forEach(cell => {
            const mobileNumber = String(cell).trim();
            if (/^\d{10}$/.test(mobileNumber)) {
              foundNumbers = true;
              const singleDigitSum = getSingleDigitSum(mobileNumber);
              html += `<tr><td>${mobileNumber}</td><td>${singleDigitSum}</td></tr>`;
            }
          });
        });

        if (!foundNumbers) {
          document.getElementById('result').innerText = "Excel ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§Æ‡§æ‡§®‡•ç‡§Ø 10-‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
        } else {
          html += "</table>";
          document.getElementById('result').innerHTML = html;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Weather and Time
    const infoBox = document.getElementById("live-info");

    function updateClock() {
      const now = new Date();
      return `üïí ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }

    function fetchWeather() {
      const apiKey = "b358267b7541c71aa767d0adf0963e0e";
      fetch(`https://api.openweathermap.org/data/2.5/weather?q=Sultanpur,IN&units=metric&appid=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          if (data.cod === 200) {
            const temp = data.main.temp;
            const desc = data.weather[0].description;
            infoBox.innerHTML = `${updateClock()}<br>üå§Ô∏è Sultanpur Weather: ${temp}¬∞C, ${desc}`;
          } else {
            infoBox.innerHTML = `${updateClock()}<br>Weather not available.`;
          }
        })
        .catch(() => {
          infoBox.innerHTML = `${updateClock()}<br>Weather not available.`;
        });
    }

    fetchWeather();
    setInterval(fetchWeather, 60000);
  </script>
</body>
</html>
