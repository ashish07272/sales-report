<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Business & Astro Tool</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx.js) for reading/writing Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ef4444; /* red-500 */
            --primary-color-dark: #dc2626; /* red-600 */
            --primary-color-light: #f87171; /* red-400 */
            --gemini-grad-from: #ef4444;
            --gemini-grad-to: #f97316;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .file-input-label {
            border: 2px dashed #4b5563; /* border-gray-600 */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .file-input-label.dragover {
            border-color: var(--primary-color);
            background-color: #1f2937; /* bg-gray-800 */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #374151; /* border-gray-700 */
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #1f2937; /* bg-gray-800 */
            color: #d1d5db; /* text-gray-300 */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .result-table-container {
            max-height: 500px;
            overflow: auto;
            border-radius: 0.5rem;
            border: 1px solid #374151;
        }
        .date-heading {
            background-color: var(--primary-color); color: white; padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 1.1rem; text-align: center;
        }
        input[type="number"], input[type="password"], select {
            background-color: #374151; border: 1px solid #4b5563; color: #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%;
        }
        select:disabled { background-color: #1f2937; cursor: not-allowed; }
        .main-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 700; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; background-color: var(--primary-color); color: white; box-shadow: 0 4px 14px 0 rgba(0,0,0, 0.2);
            transition: all 0.2s ease-in-out; cursor: pointer;
        }
        .main-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(0,0,0, 0.3); }
        .main-btn:disabled { background: #4b5563; cursor: not-allowed; box-shadow: none; }
        .tab-button {
            padding: 10px 20px; font-weight: 600; color: #9ca3af; border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .gemini-btn {
            background: linear-gradient(to right, var(--gemini-grad-from), var(--gemini-grad-to));
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse-glow-cyan {
            0%, 100% { box-shadow: 0 0 3px #67e8f9, 0 0 6px #67e8f9; }
            50% { box-shadow: 0 0 8px #a5f3fc, 0 0 12px #a5f3fc; }
        }
        .info-widget {
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: #1f2937;
        }
        .datetime-widget {
            color: #67e8f9; /* cyan-300 */
            animation: pulse-glow-cyan 5s infinite ease-in-out;
        }
        .theme-panel {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        /* Gemini Theme Overrides */
        body[data-theme="gemini"] .dynamic-color,
        body[data-theme="gemini"] .dynamic-color-light {
            background: linear-gradient(to right, #4285F4, #9B59B6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        body[data-theme="gemini"] .main-btn,
        body[data-theme="gemini"] .date-heading {
            background: linear-gradient(to right, #4285F4, #8E44AD);
        }
    </style>
</head>
<body class="text-gray-200" data-theme="red">
    <!-- This container will be populated by JS after password -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="text-center mb-10 relative">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white">
                    All-in-One <span class="dynamic-color">Business</span> Suite
                </h1>
                <p class="text-gray-400 mt-3 text-lg">VLOOKUP, SIM Report, and Mobile Sum Tool, powered by Gemini AI.</p>
                
                <!-- Date, Time, and Settings Display -->
                <div id="info-bar" class="mt-6 flex justify-center items-center gap-4 md:gap-6 text-sm">
                    <div id="datetime" class="info-widget datetime-widget flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                        <span id="time-display">Loading...</span>
                    </div>
                    <!-- Theme Settings Button -->
                    <div class="relative">
                        <button id="theme-btn" class="info-widget hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <!-- Theme Panel -->
                        <div id="theme-panel" class="theme-panel absolute top-full right-0 mt-2 w-52 bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-4 z-50 hidden transform scale-95 opacity-0">
                            <h4 class="text-white font-semibold mb-2">Select Theme</h4>
                            <div class="grid grid-cols-5 gap-2 mb-4">
                                <button class="h-8 w-8 rounded-full bg-red-500 border-2 border-transparent focus:border-white" onclick="switchTheme('red')"></button>
                                <button class="h-8 w-8 rounded-full bg-blue-500 border-2 border-transparent focus:border-white" onclick="switchTheme('blue')"></button>
                                <button class="h-8 w-8 rounded-full bg-green-500 border-2 border-transparent focus:border-white" onclick="switchTheme('green')"></button>
                                <button class="h-8 w-8 rounded-full bg-purple-500 border-2 border-transparent focus:border-white" onclick="switchTheme('purple')"></button>
                                <button class="h-8 w-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 border-2 border-transparent focus:border-white text-white" onclick="switchTheme('gemini')">✨</button>
                            </div>
                            <label for="custom-color-picker" class="text-sm font-medium text-white">Apna Rang Chunein</label>
                            <input type="color" id="custom-color-picker" class="w-full h-8 p-0 mt-1 cursor-pointer">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="border-b border-gray-700 mb-8">
                <nav class="-mb-px flex justify-center space-x-4 md:space-x-8" aria-label="Tabs">
                    <button class="tab-button active" onclick="switchTab('vlookup')">VLOOKUP Tool</button>
                    <button class="tab-button" onclick="switchTab('sim-report')">SIM Report</button>
                    <button class="tab-button" onclick="switchTab('mobile-yog')">Mobile Number Sum Tool</button>
                </nav>
            </div>

            <!-- Tab Panels -->
            <div>
                <!-- VLOOKUP Panel -->
                <div id="vlookup-panel" class="tab-panel active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold mb-4 dynamic-color-light">1. Main File (Lookup Table)</h3>
                            <label for="vlookupFile1" class="file-input-label flex flex-col items-center justify-center p-6 rounded-lg cursor-pointer"><span id="vlookupFile1-name">Choose File</span></label>
                            <input type="file" id="vlookupFile1" class="hidden" accept=".xlsx, .xls">
                            <div class="space-y-4 mt-4">
                                <select id="vlookupSheet1" disabled><option>Select Sheet</option></select>
                                <select id="vlookupKey1" disabled><option>Select Lookup Key</option></select>
                            </div>
                        </div>
                        <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold mb-4 dynamic-color-light">2. Data File (Data Table)</h3>
                            <label for="vlookupFile2" class="file-input-label flex flex-col items-center justify-center p-6 rounded-lg cursor-pointer"><span id="vlookupFile2-name">Choose File</span></label>
                            <input type="file" id="vlookupFile2" class="hidden" accept=".xlsx, .xls">
                            <div class="space-y-4 mt-4">
                                <select id="vlookupSheet2" disabled><option>Select Sheet</option></select>
                                <select id="vlookupKey2" disabled><option>Select Matching Key</option></select>
                                <select id="vlookupValue2" disabled><option>Select Return Column</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="text-center my-8">
                        <button id="processVlookupBtn" class="main-btn" disabled>Run VLOOKUP</button>
                    </div>
                    <div id="vlookupResultSection" class="hidden bg-gray-800/50 p-6 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold">Result</h3>
                            <button id="downloadVlookupBtn" class="main-btn">Download as Excel</button>
                        </div>
                        <div id="vlookupResultContainer" class="result-table-container"></div>
                    </div>
                </div>

                <!-- SIM Report Panel -->
                <div id="sim-report-panel" class="tab-panel">
                    <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center dynamic-color-light">SIM Sale Report</h2>
                        <label for="simReportFile" class="file-input-label flex items-center justify-center w-full p-6 rounded-lg cursor-pointer">
                            <span id="sim-file-name" class="font-semibold text-gray-400">Choose Report Excel File</span>
                        </label>
                        <input type="file" id="simReportFile" class="hidden" accept=".xlsx, .xls">
                        <div id="simReportActions" class="text-center my-4 hidden flex-wrap justify-center gap-4">
                            <button id="analyzeReportBtn" class="main-btn gemini-btn">✨ Analyze Report</button>
                            <button id="printReportBtn" class="main-btn">🖨️ Print Report</button>
                        </div>
                        <div id="simReportAnalysisResult" class="mt-4 p-4 bg-gray-900/50 rounded-lg whitespace-pre-wrap"></div>
                        <div id="simReportContainer" class="mt-6"></div>
                    </div>
                </div>

                <!-- Mobile Yog Panel -->
                <div id="mobile-yog-panel" class="tab-panel">
                    <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 max-w-md mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center dynamic-color-light">Mobile Number Sum Tool</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Sum of a single number:</label>
                                <input type="number" id="mobileNumberInput" placeholder="Enter 10-digit mobile number" oninput="this.value = this.value.replace(/\D/g, '').slice(0, 10)">
                                <button onclick="calculateSingleDigitSum()" class="main-btn w-full mt-3">Calculate Sum</button>
                            </div>
                            <div class="relative"><div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-600"></span></div><div class="relative flex justify-center text-sm"><span class="bg-gray-800/50 px-2 text-gray-400">OR</span></div></div>
                            <div>
                                <label for="mobileYogFile" class="file-input-label flex items-center justify-center w-full p-6 rounded-lg cursor-pointer">
                                    <span id="yog-file-name" class="font-semibold text-gray-400">Choose Excel file of numbers</span>
                                </label>
                                <input type="file" id="mobileYogFile" class="hidden" accept=".xlsx, .xls">
                                <button onclick="processExcelSingleDigit()" class="main-btn w-full mt-3">Calculate Sum from Excel</button>
                            </div>
                            <div id="mobileYogResult" class="bg-gray-900/50 p-4 rounded-lg min-h-[50px] text-center font-bold"></div>
                             <div id="numerologyActions" class="text-center my-4 hidden">
                                <button id="getNumerologyBtn" class="main-btn gemini-btn">✨ Get Numerology Insights</button>
                            </div>
                            <div id="numerologyResult" class="mt-4 p-4 bg-gray-900/50 rounded-lg whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
             <footer class="text-center text-gray-500 mt-12 py-4">
                Developed with Love ❤️ by Ashish Mishra
            </footer>
        </div>
    </div>

    <script>
    // --- PASSWORD PROTECTION & INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", function () {
        const correctPassword = "007272";
        const mainContentHTML = document.getElementById('main-content').innerHTML;
        document.getElementById('main-content').remove();

        const overlay = document.createElement("div");
        overlay.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(17,24,39,0.95); z-index:9999; display:flex; justify-content:center; align-items:center;";
        overlay.innerHTML = `<div style="background-color:#1f2937; padding:30px; border-radius:10px; text-align:center; max-width:320px; width:90%; border: 1px solid #374151;"><h3 style="color:#ef4444; font-size:1.5rem; font-weight:bold; margin-bottom:1rem;">Enter Password</h3><input type="password" id="passInput" placeholder="••••••" style="width:100%; margin:10px 0;"/><button id="submitPass" class="main-btn w-full mt-3">Submit</button><p id="errorMsg" style="color:#f87171; margin-top:10px; display:none;"></p></div>`;
        document.body.appendChild(overlay);

        const passInput = document.getElementById("passInput");
        const submitBtn = overlay.querySelector("#submitPass");

        const checkPassword = () => {
            if (passInput.value === correctPassword) {
                document.body.innerHTML = mainContentHTML;
                initializeApp();
            } else {
                const msg = document.getElementById("errorMsg");
                msg.innerText = "❌ Wrong Password !!";
                msg.style.display = "block";
            }
        };
        submitBtn.addEventListener("click", checkPassword);
        passInput.addEventListener("keyup", (event) => { if (event.key === "Enter") checkPassword(); });
        passInput.focus();
    });

    function initializeApp() {
        initVlookupTool();
        initSimSaleReport();
        initMobileYogTool();
        initTheme();
        updateTime();
        setInterval(updateTime, 1000);
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(`${tabName}-panel`).classList.add('active');
        event.currentTarget.classList.add('active');
    }
    
    // --- THEME SWITCHER LOGIC ---
    const themes = {
        red: { '--primary-color': '#ef4444', '--primary-color-light': '#f87171', '--gemini-grad-from': '#ef4444', '--gemini-grad-to': '#f97316' },
        blue: { '--primary-color': '#3b82f6', '--primary-color-light': '#60a5fa', '--gemini-grad-from': '#3b82f6', '--gemini-grad-to': '#22d3ee' },
        green: { '--primary-color': '#22c55e', '--primary-color-light': '#4ade80', '--gemini-grad-from': '#22c55e', '--gemini-grad-to': '#a3e635' },
        purple: { '--primary-color': '#8b5cf6', '--primary-color-light': '#a78bfa', '--gemini-grad-from': '#8b5cf6', '--gemini-grad-to': '#d946ef' },
        gemini: { '--primary-color': '#4285F4', '--primary-color-light': '#89b2f6' }
    };

    function applyTheme(themeName) {
        const theme = themes[themeName];
        const root = document.documentElement;
        if (theme) {
            Object.keys(theme).forEach(key => {
                root.style.setProperty(key, theme[key]);
            });
            document.body.dataset.theme = themeName;
            localStorage.setItem('selectedTheme', themeName);
            localStorage.removeItem('customThemeColor');
        }
    }

    function switchTheme(themeName) {
        applyTheme(themeName);
    }

    function initTheme() {
        const savedThemeName = localStorage.getItem('selectedTheme') || 'red';
        const savedCustomColor = localStorage.getItem('customThemeColor');

        if (savedCustomColor) {
            document.body.dataset.theme = 'custom';
            const customTheme = {
                '--primary-color': savedCustomColor,
                '--primary-color-light': savedCustomColor,
                '--gemini-grad-from': savedCustomColor,
                '--gemini-grad-to': savedCustomColor
            };
            const root = document.documentElement;
            Object.keys(customTheme).forEach(key => root.style.setProperty(key, customTheme[key]));
            document.getElementById('custom-color-picker').value = savedCustomColor;
        } else {
            applyTheme(savedThemeName);
        }
        
        const themeBtn = document.getElementById('theme-btn');
        const themePanel = document.getElementById('theme-panel');
        themeBtn.addEventListener('click', () => {
            if (themePanel.classList.contains('hidden')) {
                themePanel.classList.remove('hidden');
                setTimeout(() => themePanel.classList.remove('opacity-0', 'scale-95'), 10);
            } else {
                themePanel.classList.add('opacity-0', 'scale-95');
                setTimeout(() => themePanel.classList.add('hidden'), 300);
            }
        });

        const colorPicker = document.getElementById('custom-color-picker');
        colorPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            document.body.dataset.theme = 'custom';
            const root = document.documentElement;
            root.style.setProperty('--primary-color', color);
            root.style.setProperty('--primary-color-light', color);
            root.style.setProperty('--gemini-grad-from', color);
            root.style.setProperty('--gemini-grad-to', color);
            localStorage.setItem('customThemeColor', color);
            localStorage.removeItem('selectedTheme');
        });
    }


    // --- DATE, TIME ---
    function updateTime() {
        const timeDisplay = document.getElementById('time-display');
        if (timeDisplay) {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            timeDisplay.textContent = `${dateString} | ${timeString}`;
        }
    }

    // --- GEMINI API CALL ---
    async function callGeminiAPI(prompt, buttonElement) {
        const originalButtonContent = buttonElement.innerHTML;
        if (buttonElement.tagName === 'BUTTON') {
            buttonElement.innerHTML = '<span class="loader"></span>';
            buttonElement.disabled = true;
        }

        const apiKey = ""; // API key will be injected by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                console.error("API Error Response:", result);
                throw new Error(result.error?.message || `API Error: ${response.statusText}`);
            }
            
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.warn("API response blocked or empty:", result);
                return "The request was processed, but the AI's response was blocked, possibly due to safety filters. Please try again with different data.";
            }
        } catch (error) {
            console.error("Gemini API call failed:", error);
            return `An error occurred while contacting the AI: ${error.message}`;
        } finally {
            if (buttonElement.tagName === 'BUTTON') {
                buttonElement.innerHTML = originalButtonContent;
                buttonElement.disabled = false;
            }
        }
    }


    // --- VLOOKUP TOOL LOGIC ---
    let vlookupWb1, vlookupWb2, vlookupResultData = [];
    function initVlookupTool() {
        const fileInput1 = document.getElementById('vlookupFile1');
        const fileInput2 = document.getElementById('vlookupFile2');
        const sheetSelect1 = document.getElementById('vlookupSheet1');
        const sheetSelect2 = document.getElementById('vlookupSheet2');
        const keySelect1 = document.getElementById('vlookupKey1');
        const keySelect2 = document.getElementById('vlookupKey2');
        const valueSelect2 = document.getElementById('vlookupValue2');
        const processBtn = document.getElementById('processVlookupBtn');
        const downloadBtn = document.getElementById('downloadVlookupBtn');

        const handleFile = (file, fileNumber) => {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                if (fileNumber === 1) {
                    vlookupWb1 = workbook;
                    populateSelect(sheetSelect1, workbook.SheetNames, 'Select Sheet');
                    document.getElementById('vlookupFile1-name').textContent = file.name;
                } else {
                    vlookupWb2 = workbook;
                    populateSelect(sheetSelect2, workbook.SheetNames, 'Select Sheet');
                    document.getElementById('vlookupFile2-name').textContent = file.name;
                }
                checkVlookupSelections();
            };
            reader.readAsArrayBuffer(file);
        };
        
        const populateSelect = (selectElement, options, placeholder) => {
            selectElement.innerHTML = `<option value="">-- ${placeholder || 'Select'} --</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt; option.textContent = opt;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        };

        const populateColumnSelects = (workbook, sheetName, ...selects) => {
            const worksheet = workbook.Sheets[sheetName];
            const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0] || [];
            selects.forEach(sel => populateSelect(sel, headers, 'Select Column'));
        };

        const checkVlookupSelections = () => {
            processBtn.disabled = !(fileInput1.files.length > 0 && fileInput2.files.length > 0 && sheetSelect1.value && sheetSelect2.value && keySelect1.value && keySelect2.value && valueSelect2.value);
        };

        fileInput1.addEventListener('change', (e) => handleFile(e.target.files[0], 1));
        fileInput2.addEventListener('change', (e) => handleFile(e.target.files[0], 2));
        sheetSelect1.addEventListener('change', () => { populateColumnSelects(vlookupWb1, sheetSelect1.value, keySelect1); checkVlookupSelections(); });
        sheetSelect2.addEventListener('change', () => { populateColumnSelects(vlookupWb2, sheetSelect2.value, keySelect2, valueSelect2); checkVlookupSelections(); });
        [keySelect1, keySelect2, valueSelect2].forEach(el => el.addEventListener('change', checkVlookupSelections));
        
        processBtn.addEventListener('click', () => {
            const data1 = XLSX.utils.sheet_to_json(vlookupWb1.Sheets[sheetSelect1.value]);
            const data2 = XLSX.utils.sheet_to_json(vlookupWb2.Sheets[sheetSelect2.value]);
            const lookupMap = new Map();
            data2.forEach(row => {
                if (row[keySelect2.value] !== undefined && !lookupMap.has(row[keySelect2.value])) {
                    lookupMap.set(row[keySelect2.value], row[valueSelect2.value]);
                }
            });
            vlookupResultData = data1.map(row => ({...row, [valueSelect2.value]: lookupMap.get(row[keySelect1.value]) || 'N/A'}));
            displayVlookupResult(vlookupResultData);
        });

        downloadBtn.addEventListener('click', () => {
            if(vlookupResultData.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(vlookupResultData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Merged_Data');
            XLSX.writeFile(wb, 'VLOOKUP_Result.xlsx');
        });
    }
    
    function displayVlookupResult(data) {
        const container = document.getElementById('vlookupResultContainer');
        const section = document.getElementById('vlookupResultSection');
        if(!data || data.length === 0) { container.innerHTML = '<p>No results found.</p>'; return; }
        const headers = Object.keys(data[0]);
        let tableHTML = '<table><thead><tr>';
        headers.forEach(h => tableHTML += `<th>${h}</th>`);
        tableHTML += '</tr></thead><tbody>';
        data.forEach(row => {
            tableHTML += '<tr>';
            headers.forEach(h => tableHTML += `<td>${row[h] ?? ''}</td>`);
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
        section.classList.remove('hidden');
    }

    // --- SIM SALE REPORT LOGIC ---
    let simReportMetrics = {};
    
    function findColumnName(headers, possibleNames) {
        for (const header of headers) {
            const lowerHeader = header.toLowerCase().trim().replace(/\s+/g, ' ');
            for (const pName of possibleNames) {
                if (lowerHeader.includes(pName)) {
                    return header;
                }
            }
        }
        return null;
    }

    function parseDate(input) {
        if (!input) return null;
        if (input instanceof Date && !isNaN(input)) return input;
        if (typeof input === 'number') return new Date(Date.UTC(1899, 11, 30) + input * 86400000);
        if (typeof input === 'string') {
            const d = new Date(input);
            if (!isNaN(d)) return d;
        }
        return null;
    }

    function initSimSaleReport() {
        const uploadInput = document.getElementById('simReportFile');
        uploadInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('sim-file-name').textContent = file.name;
            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(sheet);
                displaySimReport(rawData);
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('analyzeReportBtn').addEventListener('click', async () => {
            if (Object.keys(simReportMetrics).length === 0) return;
            const analysisResultDiv = document.getElementById('simReportAnalysisResult');
            analysisResultDiv.innerHTML = '<div class="flex justify-center"><span class="loader"></span></div>';
            
            const metricsJSON = JSON.stringify(simReportMetrics, null, 2);
            const prompt = `You are a professional business analyst. Analyze the following SIM sales data metrics. Based on this data, identify key trends, highlight the top-performing and underperforming retailers, and provide concrete, actionable suggestions to boost overall sales. Structure your response clearly with headings for each section.

Here are the metrics:
${metricsJSON}`;
            
            const analysis = await callGeminiAPI(prompt, document.getElementById('analyzeReportBtn'));
            analysisResultDiv.innerText = analysis;
        });

        document.getElementById('printReportBtn').addEventListener('click', printSimReport);
    }

    function printSimReport() {
        const reportContainer = document.getElementById('simReportContainer');
        const reportHtml = reportContainer.innerHTML;
        if (!reportHtml.trim()) {
            alert("No report to print!");
            return;
        }

        const printWindow = window.open('', '_blank', 'height=800,width=1000');
        printWindow.document.write('<html><head><title>SIM Sale Summary Report</title>');
        printWindow.document.write(`
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
                th { background-color: #f2f2f2; font-weight: bold; }
                h3 { text-align: center; background-color: var(--primary-color); color: white; padding: 10px; border-radius: 5px; }
            </style>
        `);
        printWindow.document.write('</head><body>');
        printWindow.document.write(reportHtml);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
    }

    function displaySimReport(rawData) {
        const container = document.getElementById('simReportContainer');
        container.innerHTML = '';
        if (!rawData || rawData.length === 0) {
            container.innerHTML = "<p class='text-center text-red-400'>No data found in the Excel file.</p>";
            return;
        }

        const headers = Object.keys(rawData[0]);
        const dateCol = findColumnName(headers, ['date']);
        const retailerCol = findColumnName(headers, ['retailer name', 'retailer']);
        const typeCol = findColumnName(headers, ['type of caf', 'caf type']);

        if (!dateCol || !retailerCol || !typeCol) {
            let missing = [!dateCol && "'Date'", !retailerCol && "'Retailer Name'", !typeCol && "'Type of CAF'"].filter(Boolean).join(', ');
            container.innerHTML = `<p class='text-center text-red-400'>Error: Could not find required columns. Please make sure your file has columns like ${missing}.</p>`;
            return;
        }

        const retailerSummary = {}; 
        const cafTypesSet = new Set();
        const overallRetailerTotals = {};
        const overallCafTypeTotals = {};
        const groupedByDate = {};

        rawData.forEach(row => {
            const d = parseDate(row[dateCol]);
            const date = d ? d.toLocaleDateString('en-IN') : 'Unknown';
            
            const retailer = row[retailerCol] || 'Unknown';
            const type = (row[typeCol] || 'N/A').toUpperCase();
            
            if (retailer !== 'Unknown') {
                if (!overallRetailerTotals[retailer]) overallRetailerTotals[retailer] = 0;
                overallRetailerTotals[retailer]++;

                if (!retailerSummary[retailer]) retailerSummary[retailer] = {};
                if (type !== 'N/A') {
                    if (!retailerSummary[retailer][type]) retailerSummary[retailer][type] = 0;
                    retailerSummary[retailer][type]++;
                }
            }

            if (type !== 'N/A') {
                if (!overallCafTypeTotals[type]) overallCafTypeTotals[type] = 0;
                overallCafTypeTotals[type]++;
                cafTypesSet.add(type);
            }
            
            if (date !== 'Unknown') {
                if (!groupedByDate[date]) groupedByDate[date] = {};
                if (!groupedByDate[date][retailer]) groupedByDate[date][retailer] = {};
                if (!groupedByDate[date][retailer][type]) groupedByDate[date][retailer][type] = 0;
                groupedByDate[date][retailer][type]++;
            }
        });
        
        const cafTypes = Array.from(cafTypesSet).sort();
        
        let html = `<h3 class='date-heading'>Overall Summary Report</h3><table><thead><tr><th>Retailer Name</th>`;
        cafTypes.forEach(type => { html += `<th>${type}</th>`; });
        html += '<th>Total</th></tr></thead><tbody>';

        const sortedRetailersByName = Object.keys(retailerSummary).sort();

        sortedRetailersByName.forEach(retailer => {
            html += `<tr><td>${retailer}</td>`;
            let rowTotal = 0;
            cafTypes.forEach(type => {
                const count = retailerSummary[retailer][type] || 0;
                rowTotal += count;
                html += `<td>${count}</td>`;
            });
            html += `<td><b>${rowTotal}</b></td></tr>`;
        });

        html += '<tr><th>Total</th>';
        let grandTotal = 0;
        cafTypes.forEach(type => {
            const typeTotal = overallCafTypeTotals[type] || 0;
            grandTotal += typeTotal;
            html += `<th>${typeTotal}</th>`;
        });
        html += `<th>${grandTotal}</th></tr></tbody></table>`;
        
        container.innerHTML = html;
        
        const sortedRetailersBySales = Object.entries(overallRetailerTotals).sort(([,a],[,b]) => b-a);
        const dailySales = Object.keys(groupedByDate).reduce((acc, date) => {
            acc[date] = Object.values(groupedByDate[date]).reduce((sum, retailerData) => sum + Object.values(retailerData).reduce((a, b) => a + b, 0), 0);
            return acc;
        }, {});

        const dailyEntries = Object.entries(dailySales);
        const peakSale = dailyEntries.length > 0 ? dailyEntries.reduce((max, entry) => entry[1] > max[1] ? entry : max, dailyEntries[0]) : ['N/A', 0];
        const lowestSale = dailyEntries.length > 0 ? dailyEntries.reduce((min, entry) => entry[1] < min[1] ? entry : min, dailyEntries[0]) : ['N/A', 0];
        const totalDays = Object.keys(groupedByDate).length;
        const totalSales = rawData.length;

        simReportMetrics = {
            totalDays: totalDays,
            totalSales: totalSales,
            averageDailySales: totalDays > 0 ? (totalSales / totalDays).toFixed(2) : 0,
            salesByType: overallCafTypeTotals,
            top5Retailers: sortedRetailersBySales.slice(0, 5).reduce((obj, [key, value]) => ({...obj, [key]: value}), {}),
            bottom5Retailers: sortedRetailersBySales.slice(-5).reduce((obj, [key, value]) => ({...obj, [key]: value}), {}),
            peakSaleDay: { date: peakSale[0], sales: peakSale[1] },
            lowestSaleDay: { date: lowestSale[0], sales: lowestSale[1] }
        };

        document.getElementById('simReportActions').style.display = 'flex';
    }

    // --- MOBILE YOG LOGIC ---
    let currentSum = null;
    function initMobileYogTool() {
        const fileInput = document.getElementById('mobileYogFile');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) document.getElementById('yog-file-name').textContent = file.name;
        });

        document.getElementById('getNumerologyBtn').addEventListener('click', async () => {
            if (currentSum === null) return;
            const numerologyResultDiv = document.getElementById('numerologyResult');
            numerologyResultDiv.innerHTML = '<div class="flex justify-center"><span class="loader"></span></div>';
            const prompt = `Provide a brief, positive, and engaging numerology reading for the number ${currentSum}. Explain its core meaning, positive traits, potential challenges, lucky colors, and lucky days. Keep it concise and easy to read.`;
            const insights = await callGeminiAPI(prompt, document.getElementById('getNumerologyBtn'));
            numerologyResultDiv.innerText = insights;
        });
    }

    function getSingleDigitSum(numberString) {
        let sum = numberString.split('').reduce((acc, digit) => acc + parseInt(digit), 0);
        while (sum >= 10) sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
        return sum;
    }

    function calculateSingleDigitSum() {
        const numberInput = document.getElementById('mobileNumberInput').value;
        const resultDiv = document.getElementById('mobileYogResult');
        const actionsDiv = document.getElementById('numerologyActions');
        document.getElementById('numerologyResult').innerHTML = '';

        if (numberInput.length !== 10) { 
            resultDiv.innerText = "Please enter a 10-digit number."; 
            actionsDiv.classList.add('hidden');
            return; 
        }
        const sum = getSingleDigitSum(numberInput);
        currentSum = sum;
        resultDiv.innerText = `The single-digit sum is: ${sum}`;
        actionsDiv.classList.remove('hidden');
    }

    function processExcelSingleDigit() {
        const file = document.getElementById('mobileYogFile').files[0];
        const resultDiv = document.getElementById('mobileYogResult');
        document.getElementById('numerologyActions').classList.add('hidden');
        document.getElementById('numerologyResult').innerHTML = '';

        if (!file) { resultDiv.innerText = "Please select an Excel file."; return; }
        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            let html = "<table><thead><tr><th>Mobile Number</th><th>Sum</th></tr></thead><tbody>";
            let foundNumbers = false;
            jsonData.forEach(row => {
                row.forEach(cell => {
                    const mobileNumber = String(cell).trim().replace(/\D/g, '');
                    if (mobileNumber.length === 10) {
                        foundNumbers = true;
                        html += `<tr><td>${mobileNumber}</td><td>${getSingleDigitSum(mobileNumber)}</td></tr>`;
                    }
                });
            });
            if (!foundNumbers) resultDiv.innerText = "No valid 10-digit numbers found in the Excel file.";
            else resultDiv.innerHTML = html + "</tbody></table>";
        };
        reader.readAsArrayBuffer(file);
    }
    </script>
</body>
</html>
